import{d as te,r as m,a as I,m as ae,n as re,c as P,o as v,i as a,b as l,w as o,e as p,U as G,E as n,j as f,g as F,l as K,B as ne,C as de,D as S,H,V as ue,x as ie,k as C,_ as pe}from"./index-RoFsTShZ.js";import{e as O}from"./crypto-Dj8ksBse.js";const me={class:"settings-page"},fe={class:"button-group"},we={key:0,class:"twofa-content"},ce={class:"twofa-button-group"},ge={key:1,class:"twofa-content"},ve={class:"twofa-button-group"},ye={class:"button-group"},_e={key:0,style:{"text-align":"center"}},be=["src"],xe={style:{"margin-top":"15px","font-size":"12px",color:"#666"}},Ve={style:{background:"#f5f5f5",padding:"2px 6px"}},Ae=te({__name:"Settings",setup(Pe){const r=m(),k=m(!1),D=m(!1),x=m(),U=m(!1),i=I({oldPassword:"",newPassword:"",confirmPassword:""}),Q={oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度至少8位",trigger:"blur"}],confirmPassword:[{required:!0,validator:(s,e,d)=>{e===""?d(new Error("请再次输入新密码")):e!==i.newPassword?d(new Error("两次输入的密码不一致")):d()},trigger:"blur"}]},h=ae(()=>{var s;return((s=r.value)==null?void 0:s.use_2fa)===!0}),B=m(!1),q=m(!1),E=m(!1),_=m(!1),b=m(!1),V=m(""),M=m(""),y=I({code:""}),c=I({password:""}),T=async()=>{k.value=!0;try{const s=await G.getConfig();r.value=s}catch(s){console.error("加载配置失败:",s),n.error("加载配置失败")}finally{k.value=!1}},J=async()=>{if(r.value){D.value=!0;try{await G.updateConfig(r.value),n.success("配置保存成功")}catch(s){console.error("保存配置失败:",s),n.error("配置保存失败，请检查日志")}finally{D.value=!1}}},L=async()=>{x.value&&await x.value.validate(async s=>{var e;if(s){U.value=!0;try{const d=await O(i.oldPassword),u=await O(i.newPassword),g=await C.changePassword({old_password:d,new_password:u});g.status==="success"?(n.success("密码修改成功"),i.oldPassword="",i.newPassword="",i.confirmPassword="",(e=x.value)==null||e.resetFields()):n.error(g.message||"密码修改失败，请检查日志")}catch(d){console.error("修改密码失败:",d),n.error("修改密码失败，请检查日志")}finally{U.value=!1}}})},W=async()=>{B.value=!0;try{const s=await C.enable2FA();V.value=s.qr_code,M.value=s.secret,_.value=!0,n.success(s.message)}catch(s){console.error("启用 2FA 失败:",s),n.error("启用 2FA 失败，请检查日志")}finally{B.value=!1}},X=async()=>{if(!y.code){n.warning("请输入验证码");return}q.value=!0;try{const s=await C.verify2FA(y.code);s.status==="success"?(n.success("双因素认证配置成功"),_.value=!1,y.code="",V.value="",M.value="",await T()):n.error(s.message||"验证失败")}catch(s){console.error("验证 2FA 失败:",s),n.error("验证失败，请检查验证码是否正确")}finally{q.value=!1}},Y=()=>{c.password="",b.value=!0},Z=async()=>{if(!c.password){n.warning("请输入密码");return}E.value=!0;try{const s=await C.disable2FA(c.password);s.status==="success"?(n.success("双因素认证已禁用"),b.value=!1,c.password="",await T()):n.error(s.message||"禁用失败")}catch(s){console.error("禁用 2FA 失败:",s),n.error("禁用失败，请检查密码是否正确")}finally{E.value=!1}};return re(()=>{T()}),(s,e)=>{const d=p("el-input"),u=p("el-form-item"),g=p("el-icon"),w=p("el-button"),A=p("el-form"),N=p("el-card"),R=p("el-col"),$=p("el-alert"),ee=p("el-input-number"),j=p("el-switch"),le=p("el-row"),oe=p("el-divider"),z=p("el-dialog"),se=de("loading");return v(),P("div",me,[e[32]||(e[32]=a("div",{class:"page-header"},[a("h1",null,"环境设置")],-1)),l(le,{gutter:20},{default:o(()=>[l(R,{span:24,class:"settings-card"},{default:o(()=>[l(N,null,{header:o(()=>[...e[14]||(e[14]=[a("h3",null,"账户安全",-1)])]),default:o(()=>[l(A,{model:i,rules:Q,ref_key:"passwordFormRef",ref:x,"label-width":"150px"},{default:o(()=>[l(u,{label:"旧密码",prop:"oldPassword"},{default:o(()=>[l(d,{modelValue:i.oldPassword,"onUpdate:modelValue":e[0]||(e[0]=t=>i.oldPassword=t),type:"password","show-password":"",placeholder:"请输入旧密码",style:{"max-width":"400px"}},null,8,["modelValue"])]),_:1}),l(u,{label:"新密码",prop:"newPassword"},{default:o(()=>[l(d,{modelValue:i.newPassword,"onUpdate:modelValue":e[1]||(e[1]=t=>i.newPassword=t),type:"password","show-password":"",placeholder:"请输入新密码",style:{"max-width":"400px"}},null,8,["modelValue"])]),_:1}),l(u,{label:"确认新密码",prop:"confirmPassword"},{default:o(()=>[l(d,{modelValue:i.confirmPassword,"onUpdate:modelValue":e[2]||(e[2]=t=>i.confirmPassword=t),type:"password","show-password":"",placeholder:"请再次输入新密码",style:{"max-width":"400px"}},null,8,["modelValue"])]),_:1}),l(u,{class:"button-form-item"},{default:o(()=>[a("div",fe,[l(w,{type:"primary",onClick:L,loading:U.value},{default:o(()=>[l(g,null,{default:o(()=>[l(F(K))]),_:1}),e[15]||(e[15]=f(" 修改密码 ",-1))]),_:1},8,["loading"])])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),l(R,{span:24,class:"settings-card"},{default:o(()=>[l(N,null,{header:o(()=>[...e[16]||(e[16]=[a("h3",null,"@2FA配置",-1)])]),default:o(()=>[h.value?(v(),P("div",ge,[l($,{title:"已启用2FA",type:"success",description:"您的账户已启用2FA，登录时需要输入验证码。",closable:!1,style:{"margin-bottom":"20px"}}),a("div",ve,[l(w,{type:"danger",onClick:Y},{default:o(()=>[l(g,null,{default:o(()=>[l(F(K))]),_:1}),e[18]||(e[18]=f(" 禁用@2FA ",-1))]),_:1})])])):(v(),P("div",we,[l($,{title:"未配置2FA",type:"warning",description:"您尚未配置2FA。启用后，您需要使用认证器 APP（如 Google Authenticator、Microsoft Authenticator）扫描二维码绑定账户。",closable:!1,style:{"margin-bottom":"20px"}}),a("div",ce,[l(w,{type:"primary",onClick:W,loading:B.value},{default:o(()=>[l(g,null,{default:o(()=>[l(F(K))]),_:1}),e[17]||(e[17]=f(" 配置@2FA ",-1))]),_:1},8,["loading"])])]))]),_:1})]),_:1}),l(R,{span:24,class:"settings-card"},{default:o(()=>[ne((v(),S(N,null,{header:o(()=>[...e[19]||(e[19]=[a("h3",null,"环境配置",-1)])]),default:o(()=>[r.value?(v(),S(A,{key:0,model:r.value,"label-width":"150px"},{default:o(()=>[l(u,{label:"TMDB API Key",required:""},{default:o(()=>[l(d,{modelValue:r.value.tmdb_api,"onUpdate:modelValue":e[3]||(e[3]=t=>r.value.tmdb_api=t),placeholder:"请输入 TMDB API Key"},null,8,["modelValue"]),e[20]||(e[20]=a("div",{class:"form-tip"},"用于获取中文演员信息和 Emby 季标题",-1))]),_:1}),l(u,{label:"并发数",required:""},{default:o(()=>[l(ee,{modelValue:r.value.concurrent_num,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.concurrent_num=t),min:1,max:1e4},null,8,["modelValue"])]),_:1}),e[23]||(e[23]=a("div",{class:"form-tip",style:{"margin-top":"-16px","margin-bottom":"18px","margin-left":"150px"}}," 协程并发数，越大越快，但会占用更多系统资源 ",-1)),l(u,{label:"启用代理"},{default:o(()=>[l(j,{modelValue:r.value.proxy.isproxy,"onUpdate:modelValue":e[5]||(e[5]=t=>r.value.proxy.isproxy=t)},null,8,["modelValue"])]),_:1}),e[24]||(e[24]=a("div",{class:"form-tip",style:{"margin-top":"-16px","margin-bottom":"18px","margin-left":"150px"}}," 仅访问 TMDB 代理（适用于国内环境） ",-1)),r.value.proxy.isproxy?(v(),S(u,{key:0,label:"代理地址"},{default:o(()=>[l(d,{modelValue:r.value.proxy.http,"onUpdate:modelValue":e[6]||(e[6]=t=>r.value.proxy.http=t),placeholder:"http://user:pass@ip:port"},null,8,["modelValue"]),e[21]||(e[21]=a("div",{class:"form-tip"},"仅支持 HTTP 代理，格式: http://user:pass@ip:port 或 http://ip:port",-1))]),_:1})):H("",!0),l(u,{label:"启用双因素认证"},{default:o(()=>[l(j,{modelValue:r.value.use_2fa,"onUpdate:modelValue":e[7]||(e[7]=t=>r.value.use_2fa=t),disabled:""},null,8,["modelValue"])]),_:1}),e[25]||(e[25]=a("div",{class:"form-tip",style:{"margin-top":"-16px","margin-bottom":"18px","margin-left":"150px"}}," 此选项自动跟随双因素认证配置状态（配置 2FA 后自动启用，禁用 2FA 后自动关闭） ",-1)),l(u,{class:"button-form-item"},{default:o(()=>[a("div",ye,[l(w,{type:"primary",onClick:J,loading:D.value},{default:o(()=>[l(g,null,{default:o(()=>[l(F(ue))]),_:1}),e[22]||(e[22]=f(" 保存配置 ",-1))]),_:1},8,["loading"])])]),_:1})]),_:1},8,["model"])):H("",!0)]),_:1})),[[se,k.value]])]),_:1})]),_:1}),l(z,{modelValue:_.value,"onUpdate:modelValue":e[10]||(e[10]=t=>_.value=t),title:"配置@2FA",width:"500px","close-on-click-modal":!1},{footer:o(()=>[l(w,{onClick:e[9]||(e[9]=t=>_.value=!1)},{default:o(()=>[...e[28]||(e[28]=[f("取消",-1)])]),_:1}),l(w,{type:"primary",onClick:X,loading:q.value},{default:o(()=>[...e[29]||(e[29]=[f(" 验证并启用 ",-1)])]),_:1},8,["loading"])]),default:o(()=>[V.value?(v(),P("div",_e,[e[27]||(e[27]=a("p",{style:{"margin-bottom":"15px"}},"请使用认证器 APP 扫描以下二维码：",-1)),a("img",{src:V.value,alt:"QR Code",style:{"max-width":"250px",margin:"20px auto"}},null,8,be),a("p",xe,[e[26]||(e[26]=f(" 密钥：",-1)),a("code",Ve,ie(M.value),1)]),l(oe),l(A,{model:y,style:{"margin-top":"20px"}},{default:o(()=>[l(u,{label:"验证码","label-width":"80px"},{default:o(()=>[l(d,{modelValue:y.code,"onUpdate:modelValue":e[8]||(e[8]=t=>y.code=t),placeholder:"请输入 6 位验证码",maxlength:"6",style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):H("",!0)]),_:1},8,["modelValue"]),l(z,{modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=t=>b.value=t),title:"禁用双因素认证",width:"400px","close-on-click-modal":!1},{footer:o(()=>[l(w,{onClick:e[12]||(e[12]=t=>b.value=!1)},{default:o(()=>[...e[30]||(e[30]=[f("取消",-1)])]),_:1}),l(w,{type:"danger",onClick:Z,loading:E.value},{default:o(()=>[...e[31]||(e[31]=[f(" 确认禁用 ",-1)])]),_:1},8,["loading"])]),default:o(()=>[l(A,{model:c},{default:o(()=>[l(u,{label:"密码确认","label-width":"100px"},{default:o(()=>[l(d,{modelValue:c.password,"onUpdate:modelValue":e[11]||(e[11]=t=>c.password=t),type:"password","show-password":"",placeholder:"请输入密码以确认操作"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),De=pe(Ae,[["__scopeId","data-v-4ca5ea5e"]]);export{De as default};
