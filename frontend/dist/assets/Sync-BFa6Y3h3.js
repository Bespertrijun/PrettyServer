import{d as ue,r as c,n as H,p as de,c as f,o as d,i as s,b as n,w as t,e as u,R as U,E as r,q as re,I as g,J as z,D as x,H as ce,g as E,S as Q,x as b,j as m,P as me,T as pe,M as fe,Q as ve,_ as _e}from"./index--47v_MsL.js";const ye={class:"sync-page"},ge={class:"card-header"},be={key:0,class:"empty-container"},we={key:1,class:"tasks-container"},he={class:"task-card-header"},Ve={class:"task-name"},Se={class:"task-actions"},xe={class:"task-info"},Te={class:"info-item"},Ce={class:"info-item"},ke={class:"server-tags"},Ue={class:"task-card-header"},ze={class:"task-name"},Ee={class:"task-actions"},Me=ue({__name:"Sync",setup($e){const A=c("watch"),v=c([]),T=c(!1),w=c(!1),M=c(),D=c(!1),$=()=>{D.value=window.innerWidth<=768};H(()=>{$(),window.addEventListener("resize",$)}),de(()=>{window.removeEventListener("resize",$)});const B=c([{name:"1",type:"plex",url:"string",status:"connected"}]),i=c({name:"",run:!0,isfirst:!1,which:[]}),h=c(""),V=c(null);let S=null;const N=c(!1),J=c({}),R=c({}),W=async()=>{try{const a=await U.getSyncTasks();v.value=a.synctasks||[]}catch(a){console.error("加载观看同步任务失败:",a),r.error("加载观看同步任务失败: "+a.message+"，请检查日志")}},G=async()=>{T.value=!0;try{B.value=await re.getServers()}catch(a){console.error("加载服务器列表失败:",a),r.error("加载服务器列表失败: "+a.message+"，请检查日志")}finally{T.value=!1}},K=a=>{a.length===2&&M.value&&M.value.blur()},X=a=>{a.length===2&&S&&S.blur()},Y=async()=>{if(!i.value.name){r.error("请输入任务名称");return}if(i.value.which.length!==2){r.error("请选择两个服务器");return}N.value=!0;try{const a=await U.addSyncTask(i.value);a.status==="success"?(r.success("添加成功"),w.value=!1,v.value.push({...i.value}),i.value={name:"",run:!0,isfirst:!1,which:[]}):r.error(a.message||"添加失败")}catch(a){console.error("添加观看同步任务失败:",a),r.error((a.message||"添加观看同步任务失败")+"，请检查日志")}finally{N.value=!1}},Z=a=>{h.value=a.name,V.value=JSON.parse(JSON.stringify(a))},ee=()=>{if(V.value){const a=v.value.findIndex(e=>e.name===h.value);a!==-1&&(v.value[a]=V.value)}h.value="",V.value=null},le=async a=>{if(a.which.length!==2){r.error("请选择两个服务器");return}J.value[a.name]=!0;try{const e=await U.updateSyncTask(a.name,a);e.status==="success"?(r.success("保存成功"),h.value="",V.value=null):r.error(e.message||"保存失败")}catch(e){console.error("更新任务失败:",e),r.error("更新任务失败: "+e.message+"，请检查日志")}finally{J.value[a.name]=!1}},ae=async a=>{try{await ve.confirm(`确定要删除观看同步任务 "${a.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),R.value[a.name]=!0;try{const e=await U.deleteSyncTask(a.name);if(e.status==="success"){r.success("删除成功");const y=v.value.findIndex(p=>p.name===a.name);y!==-1&&v.value.splice(y,1)}else r.error(e.message||"删除失败")}finally{R.value[a.name]=!1}}catch(e){e!=="cancel"&&(console.error("删除观看同步任务失败:",e),r.error("删除观看同步任务失败: "+e.message+"，请检查日志"))}},ne=a=>a?{initializing:"初始化中",running:"运行中",stopped:"未运行",failed:"失败"}[a]:"未知",te=a=>a?{initializing:"warning",running:"success",stopped:"info",failed:"danger"}[a]:"info";return H(()=>{W(),G()}),(a,e)=>{const y=u("el-icon"),p=u("el-button"),I=u("el-empty"),C=u("el-tag"),L=u("el-divider"),k=u("el-switch"),_=u("el-form-item"),P=u("el-option"),O=u("el-select"),j=u("el-form"),q=u("el-card"),F=u("el-tab-pane"),se=u("el-tabs"),oe=u("el-input"),ie=u("el-dialog");return d(),f("div",ye,[e[23]||(e[23]=s("div",{class:"page-header"},[s("h1",null,"同步管理")],-1)),n(se,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=l=>A.value=l)},{default:t(()=>[n(F,{label:"观看同步",name:"watch"},{default:t(()=>[n(q,null,{header:t(()=>[s("div",ge,[e[9]||(e[9]=s("h3",null,"观看进度同步配置",-1)),n(p,{type:"primary",onClick:e[0]||(e[0]=l=>w.value=!0)},{default:t(()=>[n(y,null,{default:t(()=>[n(E(fe))]),_:1}),e[8]||(e[8]=s("span",null,"添加同步任务",-1))]),_:1})])]),default:t(()=>[v.value.length===0?(d(),f("div",be,[n(I,{description:"暂无观看同步任务"})])):(d(),f("div",we,[(d(!0),f(g,null,z(v.value,l=>(d(),x(q,{key:l.name,class:"task-card"},{default:t(()=>[h.value!==l.name?(d(),f(g,{key:0},[s("div",he,[s("div",Ve,[n(y,null,{default:t(()=>[n(E(Q))]),_:1}),s("span",null,b(l.name),1),n(C,{type:l.run?"success":"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[m(b(l.run?"已启用":"已禁用"),1)]),_:2},1032,["type"]),l.status?(d(),x(C,{key:0,type:te(l.status),size:"small",style:{"margin-left":"8px"}},{default:t(()=>[m(b(ne(l.status)),1)]),_:2},1032,["type"])):ce("",!0)]),s("div",Se,[n(p,{type:"primary",size:"small",onClick:o=>Z(l)},{default:t(()=>[...e[10]||(e[10]=[m(" 编辑 ",-1)])]),_:1},8,["onClick"]),n(p,{type:"danger",size:"small",onClick:o=>ae(l),icon:E(me),loading:R.value[l.name]},{default:t(()=>[...e[11]||(e[11]=[m(" 删除 ",-1)])]),_:1},8,["onClick","icon","loading"])])]),n(L),s("div",xe,[s("div",Te,[e[12]||(e[12]=s("span",{class:"info-label"},"首次同步:",-1)),n(C,{type:l.isfirst?"warning":"info",size:"small"},{default:t(()=>[m(b(l.isfirst?"是（同步所有历史记录）":"否（仅同步最近进度）"),1)]),_:2},1032,["type"])]),s("div",Ce,[e[13]||(e[13]=s("span",{class:"info-label"},"同步服务器:",-1)),s("div",ke,[(d(!0),f(g,null,z(l.which,o=>(d(),x(C,{key:o,type:"primary",size:"small"},{default:t(()=>[m(b(o),1)]),_:2},1024))),128))])])])],64)):(d(),f(g,{key:1},[s("div",Ue,[s("div",ze,[n(y,null,{default:t(()=>[n(E(Q))]),_:1}),s("span",null,b(l.name),1)]),s("div",Ee,[n(p,{type:"success",size:"small",onClick:o=>le(l),loading:J.value[l.name]},{default:t(()=>[...e[14]||(e[14]=[m(" 保存 ",-1)])]),_:1},8,["onClick","loading"]),n(p,{size:"small",onClick:ee},{default:t(()=>[...e[15]||(e[15]=[m(" 取消 ",-1)])]),_:1})])]),n(L),n(j,{model:l,"label-width":"100px",size:"small"},{default:t(()=>[n(_,{label:"是否启用"},{default:t(()=>[n(k,{modelValue:l.run,"onUpdate:modelValue":o=>l.run=o},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),n(_,{label:"首次同步"},{default:t(()=>[n(k,{modelValue:l.isfirst,"onUpdate:modelValue":o=>l.isfirst=o},null,8,["modelValue","onUpdate:modelValue"]),e[16]||(e[16]=s("div",{class:"form-tip"}," 开启后将同步所有历史观看记录，适合首次配置时使用 ",-1))]),_:2},1024),n(_,{label:"选择服务器",required:""},{default:t(()=>[n(O,{ref_for:!0,ref:o=>{o&&(pe(S)?S.value=o:S=o)},modelValue:l.which,"onUpdate:modelValue":o=>l.which=o,multiple:"",clearable:"",placeholder:"请选择两个服务器",disabled:T.value,"multiple-limit":2,style:{width:"100%"},onChange:X},{default:t(()=>[(d(!0),f(g,null,z(B.value,o=>(d(),x(P,{key:o.name,label:`${o.name} (${o.type.toUpperCase()})`,value:o.name,disabled:!l.which.includes(o.name)&&l.which.length>=2},null,8,["label","value","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),e[17]||(e[17]=s("div",{class:"form-tip"}," 请选择两个服务器进行观看进度同步（支持 Plex ↔ Emby/Jellyfin） ",-1))]),_:2},1024)]),_:2},1032,["model"])],64))]),_:2},1024))),128))]))]),_:1})]),_:1}),n(F,{label:"合集同步",name:"collection"},{default:t(()=>[n(q,null,{header:t(()=>[...e[18]||(e[18]=[s("h3",null,"合集同步配置",-1)])]),default:t(()=>[n(I,{description:"合集同步功能开发中..."})]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(ie,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=l=>w.value=l),title:"添加观看同步任务",width:D.value?"95%":"600px",center:""},{footer:t(()=>[n(p,{onClick:e[6]||(e[6]=l=>w.value=!1)},{default:t(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),n(p,{type:"primary",onClick:Y,loading:N.value},{default:t(()=>[...e[22]||(e[22]=[m("添加",-1)])]),_:1},8,["loading"])]),default:t(()=>[n(j,{model:i.value,"label-width":"120px"},{default:t(()=>[n(_,{label:"任务名称",required:""},{default:t(()=>[n(oe,{modelValue:i.value.name,"onUpdate:modelValue":e[2]||(e[2]=l=>i.value.name=l),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),n(_,{label:"是否启用"},{default:t(()=>[n(k,{modelValue:i.value.run,"onUpdate:modelValue":e[3]||(e[3]=l=>i.value.run=l)},null,8,["modelValue"])]),_:1}),n(_,{label:"首次同步"},{default:t(()=>[n(k,{modelValue:i.value.isfirst,"onUpdate:modelValue":e[4]||(e[4]=l=>i.value.isfirst=l)},null,8,["modelValue"]),e[19]||(e[19]=s("div",{class:"form-tip"}," 开启后将同步所有历史观看记录，适合首次配置时使用 ",-1))]),_:1}),n(_,{label:"选择服务器",required:""},{default:t(()=>[n(O,{ref_key:"serverSelectRef",ref:M,modelValue:i.value.which,"onUpdate:modelValue":e[5]||(e[5]=l=>i.value.which=l),multiple:"",clearable:"",placeholder:"请选择两个服务器",disabled:T.value,"multiple-limit":2,style:{width:"100%"},onChange:K},{default:t(()=>[(d(!0),f(g,null,z(B.value,l=>(d(),x(P,{key:l.name,label:`${l.name} (${l.type.toUpperCase()})`,value:l.name,disabled:!i.value.which.includes(l.name)&&i.value.which.length>=2},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue","disabled"]),e[20]||(e[20]=s("div",{class:"form-tip"}," 请选择两个服务器进行观看进度同步（支持 Plex ↔ Emby/Jellyfin） ",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"])])}}}),Ne=_e(Me,[["__scopeId","data-v-22be681e"]]);export{Ne as default};
